#!/bin/sh

keys=`grep "HK([a-z0-9_]*)" -roha ./ | awk '
	{ gsub("[()]"," ") }
	{ arr[$2] = $2 }
	END {
		e=asort(arr);
		for(i=1;i<=e;i++){
			print arr[i]
		}
	}
'`
hashkeys_c=src/libfrozen/core/hashkeys.c
hashkeys_h=src/libfrozen/core/hashkeys.h
hashkeys_int_h=src/libfrozen/core/hashkeys_int.h

i=0
echo "/* Autogenerated file. Don't edit */" > $hashkeys_h
echo "#ifndef HASHKEYS_H" >> $hashkeys_h
echo "#define HASHKEYS_H" >> $hashkeys_h
echo "" >> $hashkeys_h
echo "typedef uintmax_t hash_key_t;" >> $hashkeys_h
echo "" >> $hashkeys_h
for a in $keys; do
	i=$(($i+1))
	echo "#define HASH_KEY_$a $i" >> $hashkeys_h
done
echo "#endif" >> $hashkeys_h

echo "/* Autogenerated file. Don't edit */" > $hashkeys_int_h
echo "#ifndef HASHKEYS_INT_H" >> $hashkeys_int_h
echo "#define HASHKEYS_INT_H" >> $hashkeys_int_h
echo "" >> $hashkeys_int_h
echo "typedef struct hash_keypair_t {" >> $hashkeys_int_h
echo "    char *        key_str;" >> $hashkeys_int_h
echo "    hash_key_t    key_val;" >> $hashkeys_int_h
echo "} hash_keypair_t;" >> $hashkeys_int_h
echo "" >> $hashkeys_int_h
echo "extern hash_keypair_t hash_keys[];" >> $hashkeys_int_h
echo "extern size_t hash_keys_size;" >> $hashkeys_int_h
echo "extern size_t hash_keys_nelements;" >> $hashkeys_int_h
echo "" >> $hashkeys_int_h
echo "#endif" >> $hashkeys_int_h

i=0
echo "/* Autogenerated file. Don't edit */" > $hashkeys_c
echo "#include <libfrozen.h>" >> $hashkeys_c
echo "#include <hashkeys_int.h>" >> $hashkeys_c
echo "" >> $hashkeys_c
echo "hash_keypair_t hash_keys[] = {" >> $hashkeys_c
for a in $keys; do
	i=$(($i+1))
	echo "{ \"$a\", $i }, " >> $hashkeys_c
done
echo "};" >> $hashkeys_c
echo "size_t hash_keys_size       = sizeof(hash_keys[0]);" >> $hashkeys_c
echo "size_t hash_keys_nelements  = (sizeof(hash_keys)/sizeof(hash_keys[0]));" >> $hashkeys_c

